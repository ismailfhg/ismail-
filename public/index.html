<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHOENIX SECURE CONNECT</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; color: #d4af37; font-family: Arial, sans-serif; height: 100vh; display: flex; flex-direction: column; }
        
        /* Video Sahəsi */
        .video-container { flex: 1; display: grid; grid-template-columns: 1fr 1fr; background: #050505; gap: 5px; padding: 5px; }
        video { width: 100%; height: 100%; object-fit: cover; border: 1px solid #d4af37; border-radius: 10px; background: #111; }

        /* Çat Paneli */
        .chat-panel { height: 200px; background: #111; border-top: 2px solid #d4af37; display: flex; flex-direction: column; }
        #messages { flex: 1; overflow-y: auto; padding: 10px; font-size: 14px; }
        .controls { display: flex; padding: 10px; gap: 10px; background: #000; border-top: 1px solid #222; }
        
        input { flex: 1; background: #1a1a1a; border: 1px solid #d4af37; color: #fff; padding: 12px; border-radius: 5px; outline: none; }
        button { background: #d4af37; color: #000; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        
        /* Otaq seçimi - İlkin ekran */
        #room-selection { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="room-selection">
        <h1 style="margin-bottom: 20px;">PHOENIX CORE</h1>
        <input type="text" id="room-id" placeholder="Otaq adı (məs: biznes2026)" style="flex:none; width: 250px;">
        <button onclick="startApp()" style="margin-top: 10px; width: 250px;">BAĞLAN</button>
        <p style="font-size: 12px; margin-top: 15px; color: #666;">Hər iki cihazda eyni otaq adını yazın.</p>
    </div>

    <div class="video-container" id="video-grid"></div>

    <div class="chat-panel">
        <div id="messages"></div>
        <div class="controls">
            <input type="text" id="chat-input" placeholder="Mesaj yazın...">
            <button onclick="sendChatMessage()">GÖNDƏR</button>
            <button onclick="toggleAudio()" id="mic-btn" style="background: #444; color: white;">SƏSİ KƏS</button>
        </div>
    </div>

    <script>
        const socket = io('/');
        const videoGrid = document.getElementById('video-grid');
        const myPeer = new Peer(undefined, { host: '/', port: '443' });
        const myVideo = document.createElement('video');
        myVideo.muted = true;
        const peers = {};
        let myStream;

        function startApp() {
            const roomId = document.getElementById('room-id').value;
            if(!roomId) return alert("Otaq adı yazın!");
            document.getElementById('room-selection').style.display = 'none';

            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                myStream = stream;
                addVideoStream(myVideo, stream);

                myPeer.on('call', call => {
                    call.answer(stream);
                    const video = document.createElement('video');
                    call.on('stream', userVideoStream => {
                        addVideoStream(video, userVideoStream);
                    });
                });

                socket.on('user-connected', userId => {
                    connectToNewUser(userId, stream);
                });
            });

            myPeer.on('open', id => {
                socket.emit('join-room', roomId, id);
            });
        }

        function connectToNewUser(userId, stream) {
            const call = myPeer.call(userId, stream);
            const video = document.createElement('video');
            call.on('stream', userVideoStream => {
                addVideoStream(video, userVideoStream);
            });
            peers[userId] = call;
        }

        function addVideoStream(video, stream) {
            video.srcObject = stream;
            video.addEventListener('loadedmetadata', () => video.play());
            videoGrid.append(video);
        }

        // Real Mesajlaşma
        function sendChatMessage() {
            const msg = document.getElementById('chat-input').value;
            if(msg) {
                socket.emit('message', msg);
                document.getElementById('chat-input').value = '';
            }
        }

        socket.on('createMessage', (message, userId) => {
            const msgDiv = document.getElementById('messages');
            msgDiv.innerHTML += `<div><b>${userId.substring(0,4)}:</b> ${message}</div>`;
            msgDiv.scrollTop = msgDiv.scrollHeight;
        });

        function toggleAudio() {
            const enabled = myStream.getAudioTracks()[0].enabled;
            if (enabled) {
                myStream.getAudioTracks()[0].enabled = false;
                document.getElementById('mic-btn').innerText = "SƏSİ AÇ";
            } else {
                myStream.getAudioTracks()[0].enabled = true;
                document.getElementById('mic-btn').innerText = "SƏSİ KƏS";
            }
        }
    </script>
</body>
</html>
