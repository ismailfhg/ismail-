<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHOENIX LIVE</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { background: #000; color: #d4af37; font-family: sans-serif; margin: 0; text-align: center; }
        #video-grid { display: grid; grid-template-columns: repeat(auto-fill, 300px); grid-auto-rows: 300px; gap: 10px; justify-content: center; padding: 20px; }
        video { width: 100%; height: 100%; object-fit: cover; border: 2px solid #d4af37; border-radius: 15px; background: #111; }
        .controls { padding: 20px; background: #111; border-bottom: 1px solid #d4af37; }
        button { padding: 10px 20px; background: #d4af37; border: none; font-weight: bold; cursor: pointer; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="controls">
        <h2>PHOENIX SECURE CALL</h2>
        <button onclick="startMyVideo()">KAMERANI AÇ</button>
        <p id="my-id">Sizin ID: Yüklənir...</p>
    </div>
    
    <div id="video-grid"></div>

    <script>
        const socket = io('/');
        const videoGrid = document.getElementById('video-grid');
        const myPeer = new Peer(); // PeerJS birbaşa bağlantı yaradır
        const myVideo = document.createElement('video');
        myVideo.muted = true;

        myPeer.on('open', id => {
            document.getElementById('my-id').innerText = "ID-niz: " + id;
            socket.emit('join-room', 'PHOENIX_ROOM', id);
        });

        function startMyVideo() {
            navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            }).then(stream => {
                addVideoStream(myVideo, stream);

                myPeer.on('call', call => {
                    call.answer(stream);
                    const video = document.createElement('video');
                    call.on('stream', userVideoStream => {
                        addVideoStream(video, userVideoStream);
                    });
                });

                socket.on('user-connected', userId => {
                    connectToNewUser(userId, stream);
                });
            });
        }

        function connectToNewUser(userId, stream) {
            const call = myPeer.call(userId, stream);
            const video = document.createElement('video');
            call.on('stream', userVideoStream => {
                addVideoStream(video, userVideoStream);
            });
        }

        function addVideoStream(video, stream) {
            video.srcObject = stream;
            video.addEventListener('loadedmetadata', () => {
                video.play();
            });
            videoGrid.append(video);
        }
    </script>
</body>
</html>
